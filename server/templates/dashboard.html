<!DOCTYPE html>
<html>
<head>
    <title>GhostC2 Dashboard</title>
    <style>
        body { background: #111; color: #0f0; font-family: monospace; padding: 20px; }
        h1, h2 { color: #0f0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #0f0; padding: 8px; text-align: left; }
        th { background-color: #222; }
        input, select, button {
            background: #222;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px;
            font-family: monospace;
        }
        .form-section { margin-top: 40px; }
        .status { font-weight: bold; }
        tr:hover { background: #222; cursor: pointer; }
        #modal {
            display: none;
            position: fixed;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            background: #000;
            border: 2px solid #0f0;
            padding: 20px;
            overflow-y: scroll;
            z-index: 9999;
        }
        #modal h2 { color: #0f0; }
        #modal-close { float: right; cursor: pointer; color: #f00; font-weight: bold; }
    </style>
</head>
<body>
    <a href="/console" style="color: #0f0; text-decoration: underline;">â†’ Open Live Console</a>
    <a href="/generate" style="color: #0f0; text-decoration: underline; margin-left: 20px;">â†’ Generate Payload</a>
    <h1>ðŸ‘» GhostC2 Beacon Dashboard</h1>

    <table id="beacon-table">
        <thead>
            <tr>
                <th>Hostname</th>
                <th>IP</th>
                <th>Payload</th>
                <th>Status</th>
                <th>Last Seen</th>
            </tr>
        </thead>
        <tbody id="beacon-body">
            <!-- Populated by JS -->
        </tbody>
    </table>

    <div class="form-section">
        <h2>Add New Task</h2>
        <form method="POST" action="/add_task">
            Hostname: <input type="text" name="hostname" required><br><br>
            Command: <input type="text" name="command" required><br><br>
            <button type="submit">Send Task</button>
        </form>
    </div>

    <div class="form-section">
        <h2>Task History</h2>
        <table>
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Hostname</th>
                    <th>Command</th>
                    <th>Status</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                <tr>
                    <td>{{ task[0] }}</td>
                    <td>{{ task[1] }}</td>
                    <td>{{ task[2] }}</td>
                    <td>{{ task[3] }}</td>
                    <td><pre>{{ task[4] }}</pre></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="modal">
        <div id="modal-close" onclick="document.getElementById('modal').style.display='none'; modalOpen = false;">[X]</div>
        <h2 id="modal-title">Beacon Details</h2>
        <div id="modal-content"></div>
        <div id="modal-shell" style="margin-top: 20px;">
            <h3>Live Shell</h3>
            <form id="shell-form" onsubmit="sendShellCommand(); return false;">
                <input type="text" id="shell-input" placeholder="Enter command..." style="width: 80%;">
                <button type="submit">Send</button>
            </form>
            <pre id="shell-output">[+] Awaiting output...</pre>
        </div>
    </div>

    <script>
    let currentBeacon = "";
    let modalOpen = false;

    async function loadBeacons() {
        const res = await fetch("/api/beacons");
        const beacons = await res.json();
        const body = document.getElementById("beacon-body");
        body.innerHTML = "";

        beacons.forEach(b => {
            const row = document.createElement("tr");
            let status;
            if (b.last_seen_seconds < 60) {
                status = "ðŸŸ¢ Active";
            } else if (b.last_seen_seconds < 300) {
                status = "ðŸŸ¡ Sleeping";
            } else {
                status = "ðŸ”´ Dead";
            }

            row.setAttribute("data-hostname", b.hostname);
            row.onclick = () => showBeaconDetails(b.hostname);

            row.innerHTML = `
                <td>${b.hostname}</td>
                <td>${b.ip}</td>
                <td>${b.payload}</td>
                <td class="status">${status}</td>
                <td>${Math.round(b.last_seen_seconds)}s ago</td>
            `;
            body.appendChild(row);
        });
    }

    async function showBeaconDetails(hostname) {
        currentBeacon = hostname;
        modalOpen = true;
        const res = await fetch(`/api/beacon/${hostname}`);
        const data = await res.json();
        document.getElementById("modal-title").textContent = `Beacon: ${hostname}`;

        let html = `<p><strong>IP:</strong> ${data.ip}</p>`;
        html += `<p><strong>Last Seen:</strong> ${data.timestamp}</p>`;
        html += `<p><strong>Payload:</strong> ${data.payload}</p>`;

        document.getElementById("modal-content").innerHTML = html;
        document.getElementById("modal").style.display = "block";
        loadShellOutput();
    }

    function sendShellCommand() {
        const input = document.getElementById("shell-input").value;
        if (!input || !currentBeacon) return;

        fetch("/console_send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ hostname: currentBeacon, command: input })
        }).then(() => {
            document.getElementById("shell-input").value = "";
            document.getElementById("shell-output").textContent = "[+] Command sent. Awaiting result...";
            pollShellOutput(0);
        });
    }

    function pollShellOutput(attempts) {
        fetch(`/console_output?hostname=${currentBeacon}`)
            .then(res => res.text())
            .then(txt => {
                const outputBox = document.getElementById("shell-output");
                if (txt.includes("[+] No output yet...") && attempts < 15) {
                    setTimeout(() => pollShellOutput(attempts + 1), 2000);
                } else {
                    outputBox.textContent = txt;
                }
            });
    }

    function loadShellOutput() {
        fetch(`/console_output?hostname=${currentBeacon}`)
            .then(res => res.text())
            .then(txt => {
                document.getElementById("shell-output").textContent = txt;
            });
    }

    setInterval(() => {
        loadBeacons();
        if (modalOpen && currentBeacon) showBeaconDetails(currentBeacon);
    }, 5000);

    window.onload = loadBeacons;
    </script>
</body>
</html>